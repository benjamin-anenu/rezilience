

# Fix: Cover Image Not Loading on Reporter Page

## Root Cause

The edge function works correctly — I tested it directly and it returned a valid URL:
`https://gsphlwjoowqkqhgthxtp.supabase.co/storage/v1/object/public/report-assets/report-cover.png`

The image has been successfully generated by AI and cached in storage. The original failure was a **network timeout** during the first call (AI image generation can take 30+ seconds, and the browser timed out).

Now that the image is cached, subsequent calls return instantly. However, the component doesn't retry after the initial failure.

## Fix

Update `AdminReporterPage.tsx` to:

1. **Add retry logic** to the cover image fetch — use `useQuery` instead of a raw `useEffect` so it benefits from automatic retries and caching
2. **Add a loading/fallback state** — show a gradient placeholder while the image loads, so the cover page still looks professional even without the AI image
3. **Add error recovery** — if the fetch fails, retry up to 3 times with a delay

### File Changes

| File | Change |
|------|--------|
| `src/pages/admin/AdminReporterPage.tsx` | Replace the `useEffect` cover fetch with a `useQuery` call that has `retry: 3` and `staleTime: Infinity` (since the image is cached permanently). Add a gradient fallback placeholder for the cover image area. |

### Technical Detail

Replace lines ~128-140 (the `useEffect` for cover image) with:

```typescript
const { data: coverImageUrl } = useQuery({
  queryKey: ['report-cover-image'],
  queryFn: async () => {
    const response = await supabase.functions.invoke('generate-report-cover');
    return response.data?.url || null;
  },
  retry: 3,
  retryDelay: 2000,
  staleTime: Infinity,
});
```

This removes the manual `useState` + `useEffect` pattern and leverages React Query's built-in retry mechanism. The `staleTime: Infinity` ensures it never refetches once loaded since the image is permanently cached in storage.
