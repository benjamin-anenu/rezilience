import { Bug, ShieldAlert, ShieldCheck, Clock } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { formatDistanceToNow } from 'date-fns';

interface VulnerabilityCardProps {
  vulnerabilityCount: number;
  vulnerabilityDetails?: Array<{ id: string; summary?: string; severity?: string }> | null;
  analyzedAt?: string | null;
  openssfScore?: number | null;
  openssfChecks?: Record<string, unknown> | null;
  openssfAnalyzedAt?: string | null;
}

export function VulnerabilityCard({
  vulnerabilityCount,
  vulnerabilityDetails,
  analyzedAt,
  openssfScore,
  openssfChecks,
  openssfAnalyzedAt,
}: VulnerabilityCardProps) {
  const hasVulnData = analyzedAt != null;
  const hasOpenssfData = openssfScore != null;

  if (!hasVulnData && !hasOpenssfData) return null;

  const getVulnStatus = () => {
    if (!hasVulnData) return { label: 'Not Scanned', color: 'text-muted-foreground', icon: Clock };
    if (vulnerabilityCount === 0) return { label: 'No Known CVEs', color: 'text-primary', icon: ShieldCheck };
    if (vulnerabilityCount <= 3) return { label: `${vulnerabilityCount} Vulnerabilities`, color: 'text-amber-500', icon: ShieldAlert };
    return { label: `${vulnerabilityCount} Vulnerabilities`, color: 'text-destructive', icon: ShieldAlert };
  };

  const vulnStatus = getVulnStatus();
  const VulnIcon = vulnStatus.icon;

  const getOpenssfColor = (score: number) => {
    if (score >= 7) return 'text-primary';
    if (score >= 4) return 'text-amber-500';
    return 'text-destructive';
  };

  return (
    <Card className="card-premium card-lift border-border bg-card">
      <CardHeader className="pb-2">
        <div className="flex items-center gap-3">
          <div className="flex h-10 w-10 items-center justify-center rounded-sm bg-destructive/10">
            <Bug className="h-5 w-5 text-destructive" />
          </div>
          <div>
            <CardTitle className="font-display text-sm uppercase tracking-tight">
              SECURITY POSTURE
            </CardTitle>
            <CardDescription className={`flex items-center gap-1.5 ${vulnStatus.color}`}>
              <VulnIcon className="h-3.5 w-3.5" />
              {vulnStatus.label}
            </CardDescription>
          </div>
        </div>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {/* Vulnerability summary */}
          {hasVulnData && vulnerabilityCount > 0 && vulnerabilityDetails && (
            <div className="space-y-1.5">
              <span className="text-xs font-medium text-muted-foreground">Top CVEs</span>
              {(vulnerabilityDetails as Array<{ id: string; summary?: string; severity?: string }>)
                .slice(0, 3)
                .map((v) => (
                  <div key={v.id} className="flex items-center gap-2 text-xs">
                    <Badge
                      variant={v.severity === 'CRITICAL' || v.severity === 'HIGH' ? 'destructive' : 'outline'}
                      className="font-mono text-[10px] px-1.5"
                    >
                      {v.severity || 'UNKNOWN'}
                    </Badge>
                    <span className="text-muted-foreground truncate">{v.id}</span>
                  </div>
                ))}
            </div>
          )}

          {/* OpenSSF Score */}
          {hasOpenssfData && (
            <div className="flex items-center justify-between">
              <span className="text-xs text-muted-foreground">OpenSSF Scorecard</span>
              <span className={`font-mono text-sm font-bold ${getOpenssfColor(openssfScore!)}`}>
                {openssfScore!.toFixed(1)}/10
              </span>
            </div>
          )}

          {/* Freshness indicators */}
          <div className="space-y-0.5">
            {analyzedAt && (
              <p className="text-[10px] text-muted-foreground/70">
                CVE scan: {formatDistanceToNow(new Date(analyzedAt), { addSuffix: true })}
              </p>
            )}
            {openssfAnalyzedAt && (
              <p className="text-[10px] text-muted-foreground/70">
                OpenSSF: {formatDistanceToNow(new Date(openssfAnalyzedAt), { addSuffix: true })}
              </p>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
